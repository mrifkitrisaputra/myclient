{
    "sourceFile": "src/main/java/com/client/SimpleTestServer.java",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1765108955453,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765108976294,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,320 +1,103 @@\n-package com.client.server;\r\n+package com.client;\r\n \r\n-import java.io.BufferedReader;\r\n-import java.io.IOException;\r\n-import java.io.InputStreamReader;\r\n-import java.io.PrintWriter;\r\n-import java.net.ServerSocket;\r\n-import java.net.Socket;\r\n import java.util.ArrayList;\r\n import java.util.List;\r\n-import java.util.Map;\r\n-import java.util.concurrent.ConcurrentHashMap;\r\n import java.util.concurrent.CopyOnWriteArrayList;\r\n+import java.util.function.Consumer;\r\n \r\n-public class SimpleTestServer {\r\n+import com.client.entities.*;\r\n \r\n-    private static final int PORT = 5000;\r\n-    private static final Map<String, Room> rooms = new ConcurrentHashMap<>();\r\n-    private static final List<ClientHandler> lobbyClients = new CopyOnWriteArrayList<>();\r\n+public class ClientGameState {\r\n \r\n-    public static void main(String[] args) {\r\n-        System.out.println(\"SERVER MULTI-ROOM (PRIVATE/PUBLIC & HOST LOGIC) STARTING ON PORT \" + PORT);\r\n+    // --- GAME IDENTITY ---\r\n+    private int myPlayerId = -1;\r\n+    private int hostPlayerId = -1;\r\n \r\n-        try (ServerSocket serverSocket = new ServerSocket(PORT)) {\r\n-            while (true) {\r\n-                Socket clientSocket = serverSocket.accept();\r\n-                ClientHandler client = new ClientHandler(clientSocket);\r\n-                lobbyClients.add(client);\r\n-                new Thread(client).start();\r\n-                \r\n-                // Kirim daftar room saat baru connect\r\n-                client.sendRoomList();\r\n-            }\r\n-        } catch (IOException e) {\r\n-            e.printStackTrace();\r\n-        }\r\n-    }\r\n+    // --- DATA GAME ---\r\n+    private int[][] map;\r\n+    private boolean gameOver = false;\r\n+    private float gameTime = 0;\r\n \r\n-    // Broadcast daftar room ke SEMUA client di Lobby\r\n-    public static void broadcastRoomList() {\r\n-        StringBuilder sb = new StringBuilder(\"ROOM_LIST;\");\r\n-        for (Room room : rooms.values()) {\r\n-            // Format: NamaRoom:Status (Status = PUBLIC atau PRIVATE)\r\n-            String status = room.isPrivate ? \"PRIVATE\" : \"PUBLIC\";\r\n-            sb.append(room.name).append(\":\").append(status).append(\",\");\r\n-        }\r\n+    // Entities\r\n+    private final List<VisualPlayer> players = new CopyOnWriteArrayList<>();\r\n+    private final List<VisualBomb> bombs = new CopyOnWriteArrayList<>();\r\n+    private final List<VisualExplosion> explosions = new CopyOnWriteArrayList<>();\r\n+    private final List<VisualItem> items = new CopyOnWriteArrayList<>();\r\n \r\n-        String msg = sb.toString();\r\n-        for (ClientHandler c : lobbyClients) {\r\n-            c.send(msg);\r\n+    // --- DATA LOBBY ---\r\n+    // Menyimpan data room lengkap (Nama + Tipe)\r\n+    public static class RoomInfo {\r\n+        public String name;\r\n+        public boolean isPrivate;\r\n+        public RoomInfo(String name, boolean isPrivate) {\r\n+            this.name = name; this.isPrivate = isPrivate;\r\n         }\r\n+        @Override\r\n+        public String toString() { return name + (isPrivate ? \" (Private)\" : \" (Public)\"); }\r\n     }\r\n \r\n-    // ===================== CLASS ROOM =======================\r\n-    static class Room implements Runnable {\r\n-        String name;\r\n-        boolean isPrivate;\r\n-        String password;\r\n-        int hostId = -1; // ID Player yang jadi Host\r\n-        \r\n-        boolean gameStarted = false;\r\n-        boolean isRunning = true;\r\n+    private final List<RoomInfo> availableRooms = new ArrayList<>();\r\n+    private Consumer<List<RoomInfo>> onRoomListUpdate;\r\n+    private Consumer<String> onGameMessage; // Untuk error/notif\r\n \r\n-        List<PlayerState> players = new ArrayList<>();\r\n-        List<ClientHandler> clients = new CopyOnWriteArrayList<>();\r\n+    // --- METHODS ---\r\n+    public void setMyPlayerId(int id) { this.myPlayerId = id; }\r\n+    public int getMyPlayerId() { return myPlayerId; }\r\n+    \r\n+    public void setHostPlayerId(int id) { this.hostPlayerId = id; }\r\n+    public int getHostPlayerId() { return hostPlayerId; }\r\n+    \r\n+    public boolean amIHost() { return myPlayerId == hostPlayerId; }\r\n \r\n-        public Room(String name, boolean isPrivate, String password) {\r\n-            this.name = name;\r\n-            this.isPrivate = isPrivate;\r\n-            this.password = password;\r\n-        }\r\n+    public void updateVisuals(double dt) {\r\n+        for (VisualPlayer p : players) p.update(dt);\r\n+        for (VisualBomb b : bombs) b.update(dt);\r\n+        for (VisualExplosion e : explosions) e.update(dt);\r\n+    }\r\n \r\n-        public synchronized int addPlayer(ClientHandler client) {\r\n-            clients.add(client);\r\n-            int id = players.size(); // ID sederhana increment\r\n-            \r\n-            // Jika room kosong, pemain pertama jadi HOST\r\n-            if (hostId == -1) {\r\n-                hostId = id;\r\n-            }\r\n-\r\n-            players.add(new PlayerState(id, 100 + id * 50, 100));\r\n-            \r\n-            // Beritahu semua client di room tentang Host & ID baru\r\n-            broadcastRoomInfo();\r\n-            \r\n-            return id;\r\n-        }\r\n-\r\n-        public synchronized void removePlayer(ClientHandler client) {\r\n-            clients.remove(client);\r\n-            // Note: Dalam implementasi sederhana ini, player list tidak di-shrink indexnya \r\n-            // agar ID tetap konsisten, tapi kita tandai player tidak aktif (opsional).\r\n-            // Di sini kita fokus ke Host Migration.\r\n-\r\n-            if (clients.isEmpty()) {\r\n-                isRunning = false;\r\n-                rooms.remove(name);\r\n-                SimpleTestServer.broadcastRoomList(); // Update lobby room hilang\r\n-                System.out.println(\"[ROOM \" + name + \"] Closed.\");\r\n-            } else {\r\n-                // HOST MIGRATION\r\n-                if (client.playerId == hostId) {\r\n-                    // Host keluar, cari host baru dari klien yang tersisa\r\n-                    if (!clients.isEmpty()) {\r\n-                        hostId = clients.get(0).playerId;\r\n-                        System.out.println(\"[ROOM \" + name + \"] Host migrated to ID: \" + hostId);\r\n-                        broadcastRoomInfo();\r\n-                    }\r\n-                }\r\n-            }\r\n-        }\r\n-\r\n-        public void broadcastRoomInfo() {\r\n-            // Kirim info ID Host terbaru ke semua member room\r\n-            // Format: ROOM_INFO;HostID\r\n-            broadcast(\"ROOM_INFO;\" + hostId);\r\n-        }\r\n-\r\n-        public void broadcast(String msg) {\r\n-            for (ClientHandler c : clients) c.send(msg);\r\n-        }\r\n-\r\n-        @Override\r\n-        public void run() {\r\n-            final double speed = 1.8;\r\n-            while (isRunning) {\r\n-                try {\r\n-                    Thread.sleep(16);\r\n-                    if (!gameStarted || clients.isEmpty()) continue;\r\n-\r\n-                    for (PlayerState p : players) {\r\n-                        // Logic physics sederhana\r\n-                        if (p.up)    p.y -= speed;\r\n-                        if (p.down)  p.y += speed;\r\n-                        if (p.left)  p.x -= speed;\r\n-                        if (p.right) p.x += speed;\r\n-                    }\r\n-\r\n-                    StringBuilder sb = new StringBuilder(\"STATE;\");\r\n-                    for (int i = 0; i < players.size(); i++) {\r\n-                        PlayerState p = players.get(i);\r\n-                        sb.append(p.id).append(\",\")\r\n-                          .append((int)p.x).append(\",\")\r\n-                          .append((int)p.y).append(\",\")\r\n-                          .append(p.getState()).append(\",\")\r\n-                          .append(p.getDir());\r\n-                        if (i < players.size() - 1) sb.append(\"#\");\r\n-                    }\r\n-                    sb.append(\"|||\"); \r\n-                    broadcast(sb.toString());\r\n-\r\n-                } catch (Exception e) {}\r\n-            }\r\n-        }\r\n+    public void setOnRoomListUpdate(Consumer<List<RoomInfo>> callback) {\r\n+        this.onRoomListUpdate = callback;\r\n     }\r\n+    \r\n+    public void setOnGameMessage(Consumer<String> callback) {\r\n+        this.onGameMessage = callback;\r\n+    }\r\n+    \r\n+    public void triggerMessage(String msg) {\r\n+        if (onGameMessage != null) onGameMessage.accept(msg);\r\n+    }\r\n \r\n-    // ===================== CLIENT HANDLER =======================\r\n-    static class ClientHandler implements Runnable {\r\n-        private Socket socket;\r\n-        private PrintWriter out;\r\n-        private BufferedReader in;\r\n-        private Room currentRoom;\r\n-        public int playerId; // ID dalam room\r\n-\r\n-        public ClientHandler(Socket socket) { this.socket = socket; }\r\n-\r\n-        @Override\r\n-        public void run() {\r\n-            try {\r\n-                out = new PrintWriter(socket.getOutputStream(), true);\r\n-                in  = new BufferedReader(new InputStreamReader(socket.getInputStream()));\r\n-                String msg;\r\n-                while ((msg = in.readLine()) != null) {\r\n-                    handleMessage(msg);\r\n-                }\r\n-            } catch (IOException e) {\r\n-            } finally {\r\n-                cleanup();\r\n-            }\r\n+    public void updateRooms(List<RoomInfo> newRooms) {\r\n+        synchronized (availableRooms) {\r\n+            availableRooms.clear();\r\n+            availableRooms.addAll(newRooms);\r\n         }\r\n-\r\n-        private void cleanup() {\r\n-            lobbyClients.remove(this);\r\n-            if (currentRoom != null) {\r\n-                currentRoom.removePlayer(this);\r\n-            }\r\n+        if (onRoomListUpdate != null) {\r\n+            onRoomListUpdate.accept(newRooms);\r\n         }\r\n-\r\n-        public void sendRoomList() {\r\n-            StringBuilder sb = new StringBuilder(\"ROOM_LIST;\");\r\n-            for (Room r : rooms.values()) {\r\n-                String status = r.isPrivate ? \"PRIVATE\" : \"PUBLIC\";\r\n-                sb.append(r.name).append(\":\").append(status).append(\",\");\r\n-            }\r\n-            send(sb.toString());\r\n-        }\r\n-\r\n-        private void handleMessage(String msg) {\r\n-            // --- LOBBY LOGIC ---\r\n-            if (msg.startsWith(\"CREATE_ROOM\")) { \r\n-                // Format: CREATE_ROOM;Name;IsPrivate(true/false);Password\r\n-                String[] parts = msg.split(\";\");\r\n-                String rName = parts[1];\r\n-                boolean isPriv = Boolean.parseBoolean(parts[2]);\r\n-                String pass = parts.length > 3 ? parts[3] : \"\";\r\n-\r\n-                synchronized (rooms) {\r\n-                    if (rooms.containsKey(rName)) {\r\n-                        send(\"ERROR;Room name already exists\");\r\n-                        return;\r\n-                    }\r\n-                    Room newRoom = new Room(rName, isPriv, pass);\r\n-                    rooms.put(rName, newRoom);\r\n-                    new Thread(newRoom).start();\r\n-                    \r\n-                    broadcastRoomList(); // Update semua orang di lobby\r\n-                    joinRoom(newRoom);\r\n-                }\r\n-                return;\r\n-            }\r\n-\r\n-            if (msg.startsWith(\"JOIN_ROOM\")) {\r\n-                // Format: JOIN_ROOM;Name;PasswordInput\r\n-                String[] parts = msg.split(\";\");\r\n-                String rName = parts[1];\r\n-                String inputPass = parts.length > 2 ? parts[2] : \"\";\r\n-\r\n-                Room r = rooms.get(rName);\r\n-                if (r == null) {\r\n-                    send(\"ERROR;Room not found\");\r\n-                    return;\r\n-                }\r\n-\r\n-                if (r.isPrivate && !r.password.equals(inputPass)) {\r\n-                    send(\"ERROR;Wrong Password\");\r\n-                    return;\r\n-                }\r\n-\r\n-                joinRoom(r);\r\n-                return;\r\n-            }\r\n-\r\n-            // --- GAME LOGIC ---\r\n-            if (currentRoom == null) return;\r\n-\r\n-            if (msg.equals(\"START_GAME\")) {\r\n-                // 1. Cek apakah pengirim adalah HOST\r\n-                if (this.playerId != currentRoom.hostId) {\r\n-                    // Abaikan atau kirim warning (UI client yg harusnya disable tombol)\r\n-                    return; \r\n-                }\r\n-                // 2. Cek Minimal Player\r\n-                if (currentRoom.clients.size() < 2) {\r\n-                    send(\"ERROR;Need at least 2 players to start!\");\r\n-                    return;\r\n-                }\r\n-                \r\n-                currentRoom.gameStarted = true;\r\n-                currentRoom.broadcast(\"MAP;13;13;\" + generateMap());\r\n-                currentRoom.broadcast(\"TIME;120\");\r\n-                System.out.println(\"Game started in room \" + currentRoom.name);\r\n-            }\r\n-\r\n-            // Input handling biasa...\r\n-            if (msg.startsWith(\"INPUT\")) {\r\n-               // ... logic input sama seperti sebelumnya ...\r\n-               String[] parts = msg.split(\";\");\r\n-               if (playerId < currentRoom.players.size()) {\r\n-                   PlayerState p = currentRoom.players.get(playerId);\r\n-                   boolean pressed = parts[2].equals(\"TRUE\");\r\n-                   switch (parts[1]) {\r\n-                       case \"UP\" -> p.up = pressed;\r\n-                       case \"DOWN\" -> p.down = pressed;\r\n-                       case \"LEFT\" -> p.left = pressed;\r\n-                       case \"RIGHT\" -> p.right = pressed;\r\n-                   }\r\n-               }\r\n-            }\r\n-            \r\n-            if (msg.equals(\"LEAVE_ROOM\")) {\r\n-                currentRoom.removePlayer(this);\r\n-                currentRoom = null;\r\n-                lobbyClients.add(this);\r\n-                sendRoomList();\r\n-            }\r\n-        }\r\n-\r\n-        private void joinRoom(Room room) {\r\n-            if (this.currentRoom != null) this.currentRoom.removePlayer(this);\r\n-            lobbyClients.remove(this);\r\n-            \r\n-            this.currentRoom = room;\r\n-            this.playerId = room.addPlayer(this);\r\n-            \r\n-            // Beritahu ID Client ini ke Client\r\n-            // JOIN_SUCCESS;MyID;HostID\r\n-            send(\"JOIN_SUCCESS;\" + this.playerId + \";\" + room.hostId);\r\n-        }\r\n-\r\n-        public void send(String msg) {\r\n-            if (out != null) out.println(msg);\r\n-        }\r\n     }\r\n+    \r\n+    public List<RoomInfo> getAvailableRooms() { return availableRooms; }\r\n \r\n-    // Class PlayerState dan generateMap sama seperti sebelumnya (disingkat)\r\n-    static class PlayerState {\r\n-        int id; double x, y;\r\n-        boolean up, down, left, right;\r\n-        public PlayerState(int id, double x, double y) {this.id=id; this.x=x; this.y=y;}\r\n-        public String getState() { return (up||down||left||right) ? \"WALK\" : \"IDLE\"; }\r\n-        public String getDir() { return \"DOWN\"; } // Simplifikasi\r\n+    // Setters Entities (Sama seperti sebelumnya)\r\n+    public void setMap(int[][] newMap) { this.map = newMap; }\r\n+    public void setGameTime(float time) { this.gameTime = time; }\r\n+    public void setGameOver(boolean status) { this.gameOver = status; }\r\n+    public void updatePlayers(List<VisualPlayer> newPlayers) {\r\n+        players.clear(); players.addAll(newPlayers);\r\n     }\r\n+    public void updateBombs(List<VisualBomb> newBombs) {\r\n+        bombs.clear(); bombs.addAll(newBombs);\r\n+    }\r\n+    public void updateExplosions(List<VisualExplosion> newExplosions) {\r\n+        explosions.clear(); explosions.addAll(newExplosions);\r\n+    }\r\n+    public void updateItems(List<VisualItem> newItems) {\r\n+        items.clear(); items.addAll(newItems);\r\n+    }\r\n+    public void clearPlayers() { players.clear(); }\r\n     \r\n-    private static String generateMap() {\r\n-        StringBuilder map = new StringBuilder();\r\n-        for (int i=0; i<169; i++) map.append(\"0,\"); // Dummy map\r\n-        return map.toString();\r\n-    }\r\n+    // Getters\r\n+    public List<VisualPlayer> getPlayers() { return players; }\r\n+    public int[][] getMap() { return map; }\r\n }\n\\ No newline at end of file\n"
                }
            ],
            "date": 1765108955453,
            "name": "Commit-0",
            "content": "package com.client;\r\n\r\nimport java.io.BufferedReader;\r\nimport java.io.IOException;\r\nimport java.io.InputStreamReader;\r\nimport java.io.PrintWriter;\r\nimport java.net.ServerSocket;\r\nimport java.net.Socket;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.concurrent.ConcurrentHashMap;\r\nimport java.util.concurrent.CopyOnWriteArrayList;\r\n\r\npublic class SimpleTestServer {\r\n\r\n    private static final int PORT = 5000;\r\n    private static final Map<String, Room> rooms = new ConcurrentHashMap<>();\r\n    private static final List<ClientHandler> lobbyClients = new CopyOnWriteArrayList<>();\r\n\r\n    public static void main(String[] args) {\r\n        System.out.println(\"SERVER MULTI-ROOM (PRIVATE/PUBLIC & HOST LOGIC) STARTING ON PORT \" + PORT);\r\n\r\n        try (ServerSocket serverSocket = new ServerSocket(PORT)) {\r\n            while (true) {\r\n                Socket clientSocket = serverSocket.accept();\r\n                ClientHandler client = new ClientHandler(clientSocket);\r\n                lobbyClients.add(client);\r\n                new Thread(client).start();\r\n                \r\n                // Kirim daftar room saat baru connect\r\n                client.sendRoomList();\r\n            }\r\n        } catch (IOException e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n\r\n    // Broadcast daftar room ke SEMUA client di Lobby\r\n    public static void broadcastRoomList() {\r\n        StringBuilder sb = new StringBuilder(\"ROOM_LIST;\");\r\n        for (Room room : rooms.values()) {\r\n            // Format: NamaRoom:Status (Status = PUBLIC atau PRIVATE)\r\n            String status = room.isPrivate ? \"PRIVATE\" : \"PUBLIC\";\r\n            sb.append(room.name).append(\":\").append(status).append(\",\");\r\n        }\r\n\r\n        String msg = sb.toString();\r\n        for (ClientHandler c : lobbyClients) {\r\n            c.send(msg);\r\n        }\r\n    }\r\n\r\n    // ===================== CLASS ROOM =======================\r\n    static class Room implements Runnable {\r\n        String name;\r\n        boolean isPrivate;\r\n        String password;\r\n        int hostId = -1; // ID Player yang jadi Host\r\n        \r\n        boolean gameStarted = false;\r\n        boolean isRunning = true;\r\n\r\n        List<PlayerState> players = new ArrayList<>();\r\n        List<ClientHandler> clients = new CopyOnWriteArrayList<>();\r\n\r\n        public Room(String name, boolean isPrivate, String password) {\r\n            this.name = name;\r\n            this.isPrivate = isPrivate;\r\n            this.password = password;\r\n        }\r\n\r\n        public synchronized int addPlayer(ClientHandler client) {\r\n            clients.add(client);\r\n            int id = players.size(); // ID sederhana increment\r\n            \r\n            // Jika room kosong, pemain pertama jadi HOST\r\n            if (hostId == -1) {\r\n                hostId = id;\r\n            }\r\n\r\n            players.add(new PlayerState(id, 100 + id * 50, 100));\r\n            \r\n            // Beritahu semua client di room tentang Host & ID baru\r\n            broadcastRoomInfo();\r\n            \r\n            return id;\r\n        }\r\n\r\n        public synchronized void removePlayer(ClientHandler client) {\r\n            clients.remove(client);\r\n            // Note: Dalam implementasi sederhana ini, player list tidak di-shrink indexnya \r\n            // agar ID tetap konsisten, tapi kita tandai player tidak aktif (opsional).\r\n            // Di sini kita fokus ke Host Migration.\r\n\r\n            if (clients.isEmpty()) {\r\n                isRunning = false;\r\n                rooms.remove(name);\r\n                SimpleTestServer.broadcastRoomList(); // Update lobby room hilang\r\n                System.out.println(\"[ROOM \" + name + \"] Closed.\");\r\n            } else {\r\n                // HOST MIGRATION\r\n                if (client.playerId == hostId) {\r\n                    // Host keluar, cari host baru dari klien yang tersisa\r\n                    if (!clients.isEmpty()) {\r\n                        hostId = clients.get(0).playerId;\r\n                        System.out.println(\"[ROOM \" + name + \"] Host migrated to ID: \" + hostId);\r\n                        broadcastRoomInfo();\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        public void broadcastRoomInfo() {\r\n            // Kirim info ID Host terbaru ke semua member room\r\n            // Format: ROOM_INFO;HostID\r\n            broadcast(\"ROOM_INFO;\" + hostId);\r\n        }\r\n\r\n        public void broadcast(String msg) {\r\n            for (ClientHandler c : clients) c.send(msg);\r\n        }\r\n\r\n        @Override\r\n        public void run() {\r\n            final double speed = 1.8;\r\n            while (isRunning) {\r\n                try {\r\n                    Thread.sleep(16);\r\n                    if (!gameStarted || clients.isEmpty()) continue;\r\n\r\n                    for (PlayerState p : players) {\r\n                        // Logic physics sederhana\r\n                        if (p.up)    p.y -= speed;\r\n                        if (p.down)  p.y += speed;\r\n                        if (p.left)  p.x -= speed;\r\n                        if (p.right) p.x += speed;\r\n                    }\r\n\r\n                    StringBuilder sb = new StringBuilder(\"STATE;\");\r\n                    for (int i = 0; i < players.size(); i++) {\r\n                        PlayerState p = players.get(i);\r\n                        sb.append(p.id).append(\",\")\r\n                          .append((int)p.x).append(\",\")\r\n                          .append((int)p.y).append(\",\")\r\n                          .append(p.getState()).append(\",\")\r\n                          .append(p.getDir());\r\n                        if (i < players.size() - 1) sb.append(\"#\");\r\n                    }\r\n                    sb.append(\"|||\"); \r\n                    broadcast(sb.toString());\r\n\r\n                } catch (Exception e) {}\r\n            }\r\n        }\r\n    }\r\n\r\n    // ===================== CLIENT HANDLER =======================\r\n    static class ClientHandler implements Runnable {\r\n        private Socket socket;\r\n        private PrintWriter out;\r\n        private BufferedReader in;\r\n        private Room currentRoom;\r\n        public int playerId; // ID dalam room\r\n\r\n        public ClientHandler(Socket socket) { this.socket = socket; }\r\n\r\n        @Override\r\n        public void run() {\r\n            try {\r\n                out = new PrintWriter(socket.getOutputStream(), true);\r\n                in  = new BufferedReader(new InputStreamReader(socket.getInputStream()));\r\n                String msg;\r\n                while ((msg = in.readLine()) != null) {\r\n                    handleMessage(msg);\r\n                }\r\n            } catch (IOException e) {\r\n            } finally {\r\n                cleanup();\r\n            }\r\n        }\r\n\r\n        private void cleanup() {\r\n            lobbyClients.remove(this);\r\n            if (currentRoom != null) {\r\n                currentRoom.removePlayer(this);\r\n            }\r\n        }\r\n\r\n        public void sendRoomList() {\r\n            StringBuilder sb = new StringBuilder(\"ROOM_LIST;\");\r\n            for (Room r : rooms.values()) {\r\n                String status = r.isPrivate ? \"PRIVATE\" : \"PUBLIC\";\r\n                sb.append(r.name).append(\":\").append(status).append(\",\");\r\n            }\r\n            send(sb.toString());\r\n        }\r\n\r\n        private void handleMessage(String msg) {\r\n            // --- LOBBY LOGIC ---\r\n            if (msg.startsWith(\"CREATE_ROOM\")) { \r\n                // Format: CREATE_ROOM;Name;IsPrivate(true/false);Password\r\n                String[] parts = msg.split(\";\");\r\n                String rName = parts[1];\r\n                boolean isPriv = Boolean.parseBoolean(parts[2]);\r\n                String pass = parts.length > 3 ? parts[3] : \"\";\r\n\r\n                synchronized (rooms) {\r\n                    if (rooms.containsKey(rName)) {\r\n                        send(\"ERROR;Room name already exists\");\r\n                        return;\r\n                    }\r\n                    Room newRoom = new Room(rName, isPriv, pass);\r\n                    rooms.put(rName, newRoom);\r\n                    new Thread(newRoom).start();\r\n                    \r\n                    broadcastRoomList(); // Update semua orang di lobby\r\n                    joinRoom(newRoom);\r\n                }\r\n                return;\r\n            }\r\n\r\n            if (msg.startsWith(\"JOIN_ROOM\")) {\r\n                // Format: JOIN_ROOM;Name;PasswordInput\r\n                String[] parts = msg.split(\";\");\r\n                String rName = parts[1];\r\n                String inputPass = parts.length > 2 ? parts[2] : \"\";\r\n\r\n                Room r = rooms.get(rName);\r\n                if (r == null) {\r\n                    send(\"ERROR;Room not found\");\r\n                    return;\r\n                }\r\n\r\n                if (r.isPrivate && !r.password.equals(inputPass)) {\r\n                    send(\"ERROR;Wrong Password\");\r\n                    return;\r\n                }\r\n\r\n                joinRoom(r);\r\n                return;\r\n            }\r\n\r\n            // --- GAME LOGIC ---\r\n            if (currentRoom == null) return;\r\n\r\n            if (msg.equals(\"START_GAME\")) {\r\n                // 1. Cek apakah pengirim adalah HOST\r\n                if (this.playerId != currentRoom.hostId) {\r\n                    // Abaikan atau kirim warning (UI client yg harusnya disable tombol)\r\n                    return; \r\n                }\r\n                // 2. Cek Minimal Player\r\n                if (currentRoom.clients.size() < 2) {\r\n                    send(\"ERROR;Need at least 2 players to start!\");\r\n                    return;\r\n                }\r\n                \r\n                currentRoom.gameStarted = true;\r\n                currentRoom.broadcast(\"MAP;13;13;\" + generateMap());\r\n                currentRoom.broadcast(\"TIME;120\");\r\n                System.out.println(\"Game started in room \" + currentRoom.name);\r\n            }\r\n\r\n            // Input handling biasa...\r\n            if (msg.startsWith(\"INPUT\")) {\r\n               // ... logic input sama seperti sebelumnya ...\r\n               String[] parts = msg.split(\";\");\r\n               if (playerId < currentRoom.players.size()) {\r\n                   PlayerState p = currentRoom.players.get(playerId);\r\n                   boolean pressed = parts[2].equals(\"TRUE\");\r\n                   switch (parts[1]) {\r\n                       case \"UP\" -> p.up = pressed;\r\n                       case \"DOWN\" -> p.down = pressed;\r\n                       case \"LEFT\" -> p.left = pressed;\r\n                       case \"RIGHT\" -> p.right = pressed;\r\n                   }\r\n               }\r\n            }\r\n            \r\n            if (msg.equals(\"LEAVE_ROOM\")) {\r\n                currentRoom.removePlayer(this);\r\n                currentRoom = null;\r\n                lobbyClients.add(this);\r\n                sendRoomList();\r\n            }\r\n        }\r\n\r\n        private void joinRoom(Room room) {\r\n            if (this.currentRoom != null) this.currentRoom.removePlayer(this);\r\n            lobbyClients.remove(this);\r\n            \r\n            this.currentRoom = room;\r\n            this.playerId = room.addPlayer(this);\r\n            \r\n            // Beritahu ID Client ini ke Client\r\n            // JOIN_SUCCESS;MyID;HostID\r\n            send(\"JOIN_SUCCESS;\" + this.playerId + \";\" + room.hostId);\r\n        }\r\n\r\n        public void send(String msg) {\r\n            if (out != null) out.println(msg);\r\n        }\r\n    }\r\n\r\n    // Class PlayerState dan generateMap sama seperti sebelumnya (disingkat)\r\n    static class PlayerState {\r\n        int id; double x, y;\r\n        boolean up, down, left, right;\r\n        public PlayerState(int id, double x, double y) {this.id=id; this.x=x; this.y=y;}\r\n        public String getState() { return (up||down||left||right) ? \"WALK\" : \"IDLE\"; }\r\n        public String getDir() { return \"DOWN\"; } // Simplifikasi\r\n    }\r\n    \r\n    private static String generateMap() {\r\n        StringBuilder map = new StringBuilder();\r\n        for (int i=0; i<169; i++) map.append(\"0,\"); // Dummy map\r\n        return map.toString();\r\n    }\r\n}"
        }
    ]
}